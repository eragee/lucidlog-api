<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>lucidlog-api Tester</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f7;
      }

      .app-container {
        max-width: 900px;
        margin: 2rem auto;
        padding: 1.5rem;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      }

      h1 {
        margin-top: 0;
        font-size: 1.6rem;
      }

      .field {
        margin-bottom: 1rem;
      }

      .field label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.35rem;
      }

      .field textarea {
        width: 100%;
        min-height: 80px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 0.9rem;
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        resize: vertical;
      }

      .field small {
        color: #666;
      }

      .actions {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 0.5rem;
        margin-bottom: 1rem;
      }

      button {
        border: none;
        background: #007aff;
        color: white;
        padding: 0.6rem 1.2rem;
        border-radius: 999px;
        font-size: 0.95rem;
        cursor: pointer;
      }

      button:disabled {
        opacity: 0.6;
        cursor: default;
      }

      .status {
        font-size: 0.9rem;
        color: #444;
      }

      .error {
        color: #b00020;
      }

      pre {
        background: #111827;
        color: #e5e7eb;
        padding: 0.75rem;
        border-radius: 8px;
        font-size: 0.85rem;
        overflow-x: auto;
      }
    </style>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      // Updated for same-origin requests when UI and API are in the same container
      const API_URL = "/explain-log";

      function App() {
        const [logText, setLogText] = React.useState("");
        const [contextText, setContextText] = React.useState("");
        const [responseData, setResponseData] = React.useState(null);
        const [error, setError] = React.useState(null);
        const [loading, setLoading] = React.useState(false);

        const handleSubmit = async (e) => {
          e.preventDefault();
          setError(null);
          setResponseData(null);

          if (!logText.trim()) {
            setError("The 'log' field is required.");
            return;
          }

          let payload = { log: logText.trim() };

          if (contextText.trim()) {
            try {
              const parsed = JSON.parse(contextText);
              payload.context = parsed;
            } catch (err) {
              setError("Context must be valid JSON if provided.");
              return;
            }
          }

          setLoading(true);
          try {
            const res = await fetch(API_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            const data = await res.json();
            setResponseData(data);
          } catch (err) {
            setError("Network or fetch error while contacting lucidlog-api.");
          } finally {
            setLoading(false);
          }
        };

        return (
          <div className="app-container">
            <h1>lucidlog-api Tester</h1>
            <p>
              Sends a log entry and optional context to the lucidlog-api backend
              and displays the JSON explanation response.
            </p>

            <form onSubmit={handleSubmit}>
              <div className="field">
                <label htmlFor="log">Log entry (required)</label>
                <textarea
                  id="log"
                  value={logText}
                  onChange={(e) => setLogText(e.target.value)}
                  placeholder='Example: 2025-11-14T03:21:15Z ERROR auth-service Failed login for user alice (401)'
                />
              </div>

              <div className="field">
                <label htmlFor="context">Context (optional JSON)</label>
                <textarea
                  id="context"
                  value={contextText}
                  onChange={(e) => setContextText(e.target.value)}
                  placeholder='Example: {"host": "node-03", "cluster": "prod-gke-1"}'
                />
                <small>Context is optional but must be valid JSON if provided.</small>
              </div>

              <div className="actions">
                <button type="submit" disabled={loading}>
                  {loading ? "Explaining..." : "Explain Log"}
                </button>
                <div className="status">
                  Using endpoint: <code>{API_URL}</code>
                </div>
              </div>
            </form>

            {error && <div className="error">{error}</div>}

            {responseData && (
              <div>
                <h2>Response</h2>
                <pre>{JSON.stringify(responseData, null, 2)}</pre>
              </div>
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
