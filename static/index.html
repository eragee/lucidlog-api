<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>lucidlog-api Tester</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f7;
      }

      .app-container {
        max-width: 900px;
        margin: 2rem auto;
        padding: 1.5rem;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      }

      h1 {
        margin-top: 0;
        font-size: 1.6rem;
      }

      .field {
        margin-bottom: 1rem;
      }

      .field label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.35rem;
      }

      .field textarea {
        width: 100%;
        min-height: 80px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 0.9rem;
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        resize: vertical;
      }

      .field small {
        color: #666;
      }

      .actions {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }

      button {
        border: none;
        background: #007aff;
        color: white;
        padding: 0.6rem 1.2rem;
        border-radius: 999px;
        font-size: 0.95rem;
        cursor: pointer;
      }

      button:disabled {
        opacity: 0.6;
        cursor: default;
      }

      .status {
        font-size: 0.9rem;
        color: #444;
      }

      .error {
        color: #b00020;
        margin-top: 0.5rem;
        font-size: 0.95rem;
      }

      .result-card {
        margin-top: 1.5rem;
        padding: 1rem 1.25rem;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
      }

      .result-card h2 {
        margin-top: 0;
        margin-bottom: 0.75rem;
      }

      .result-section {
        margin-bottom: 0.85rem;
      }

      .result-section h3 {
        margin: 0 0 0.25rem 0;
        font-size: 1rem;
      }

      .badge-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.15rem 0.55rem;
        border-radius: 999px;
        font-size: 0.8rem;
        background: #e5e7eb;
        color: #111827;
      }

      .badge-severity-ERROR {
        background: #fee2e2;
        color: #991b1b;
      }

      .badge-severity-WARN {
        background: #fef3c7;
        color: #92400e;
      }

      .badge-severity-INFO {
        background: #dbeafe;
        color: #1e40af;
      }

      .mono-block {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 0.88rem;
        background: #111827;
        color: #e5e7eb;
        padding: 0.55rem 0.65rem;
        border-radius: 6px;
        overflow-x: auto;
        margin: 0;
      }

      ul {
        margin: 0.25rem 0 0.25rem 1.2rem;
      }

      pre.raw-json {
        background: #111827;
        color: #e5e7eb;
        padding: 0.75rem;
        border-radius: 8px;
        font-size: 0.85rem;
        overflow-x: auto;
      }
    </style>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      const API_URL = "/explain-log";

      function App() {
        const [logText, setLogText] = React.useState("");
        const [contextText, setContextText] = React.useState("");
        const [responseData, setResponseData] = React.useState(null);
        const [error, setError] = React.useState(null);
        const [loading, setLoading] = React.useState(false);

        const handleSubmit = async (e) => {
          e.preventDefault();
          setError(null);
          setResponseData(null);

          if (!logText.trim()) {
            setError("The 'log' field is required.");
            return;
          }

          const payload = { log: logText.trim() };

          if (contextText.trim()) {
            try {
              const parsed = JSON.parse(contextText);
              payload.context = parsed;
            } catch (err) {
              setError("Context must be valid JSON if provided.");
              return;
            }
          }

          setLoading(true);
          try {
            const res = await fetch(API_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            const data = await res.json();
            setResponseData(data);
          } catch (err) {
            setError("Network or fetch error while contacting lucidlog-api.");
          } finally {
            setLoading(false);
          }
        };

        const renderResult = () => {
          if (!responseData) {
            return null;
          }

          const isOk = responseData.status === "OK" && responseData.result;
          if (!isOk) {
            return (
              <div className="result-card">
                <h2>Raw Response</h2>
                <pre className="raw-json">
                  {JSON.stringify(responseData, null, 2)}
                </pre>
              </div>
            );
          }

          const r = responseData.result || {};
          const severity = r.severity || "UNKNOWN";
          const component = r.component || "Unknown component";
          const summary = r.summary || "";
          const probableCauses = Array.isArray(r.probable_causes)
            ? r.probable_causes
            : [];
          const recommendedActions = Array.isArray(r.recommended_actions)
            ? r.recommended_actions
            : [];
          const rawLog = r.raw_log || "";

          const severityClass =
            "badge badge-severity-" + (severity || "").toUpperCase();

          return (
            <div className="result-card">
              <h2>Explanation</h2>

              <div className="badge-row">
                <span className={severityClass}>Severity: {severity}</span>
                <span className="badge">Component: {component}</span>
              </div>

              {summary && (
                <div className="result-section">
                  <h3>Summary</h3>
                  <p>{summary}</p>
                </div>
              )}

              {rawLog && (
                <div className="result-section">
                  <h3>Raw log</h3>
                  <p className="mono-block">{rawLog}</p>
                </div>
              )}

              {probableCauses.length > 0 && (
                <div className="result-section">
                  <h3>Probable causes</h3>
                  <ul>
                    {probableCauses.map((item, idx) => (
                      <li key={idx}>{item}</li>
                    ))}
                  </ul>
                </div>
              )}

              {recommendedActions.length > 0 && (
                <div className="result-section">
                  <h3>Recommended actions</h3>
                  <ul>
                    {recommendedActions.map((item, idx) => (
                      <li key={idx}>{item}</li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          );
        };

        return (
          <div className="app-container">
            <h1>lucidlog-api Tester</h1>
            <p>
              Sends a log entry and optional context to the lucidlog-api backend
              and formats the explanation response.
            </p>

            <form onSubmit={handleSubmit}>
              <div className="field">
                <label htmlFor="log">Log entry (required)</label>
                <textarea
                  id="log"
                  value={logText}
                  onChange={(e) => setLogText(e.target.value)}
                  placeholder='Example: 2025-11-14T03:21:15Z ERROR auth-service Failed login for user alice (401)'
                />
              </div>

              <div className="field">
                <label htmlFor="context">Context (optional JSON)</label>
                <textarea
                  id="context"
                  value={contextText}
                  onChange={(e) => setContextText(e.target.value)}
                  placeholder='Example: {"host": "node-03", "cluster": "prod-gke-1"}'
                />
                <small>Context is optional but must be valid JSON if provided.</small>
              </div>

              <div className="actions">
                <button type="submit" disabled={loading}>
                  {loading ? "Explaining..." : "Explain Log"}
                </button>
                <div className="status">
                  Endpoint: <code>{API_URL}</code>
                </div>
              </div>
            </form>

            {error && <div className="error">{error}</div>}

            {renderResult()}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
